# ç†è§£æµè§ˆå™¨çš„ç¼“å­˜æœºåˆ¶

> ç¼“å­˜æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸­ç®€å•é«˜æ•ˆçš„ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼Œä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ç­–ç•¥å¯ä»¥ç¼©çŸ­ç½‘é¡µè¯·æ±‚èµ„æºçš„è·ç¦»ï¼Œå‡å°‘å»¶è¿Ÿã€‚å¹¶ä¸”ç”±äºç¼“å­˜æ–‡ä»¶å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œè¿˜å¯ä»¥å‡å°‘å¸¦å®½ï¼Œé™ä½ç½‘ç»œè´Ÿè·ã€‚
>
> å¯¹äºä¸€ä¸ªæ•°æ®è¯·æ±‚æ¥è¯´ï¼Œå¯ä»¥åˆ†ä¸ºå‘èµ·ä¸‰ä¸ªæ­¥éª¤ï¼š
>
> - **ç½‘ç»œè¯·æ±‚**
>
> - **åç«¯å¤„ç†**
>
> - **æµè§ˆå™¨å“åº”**
>
> æµè§ˆå™¨ç¼“å­˜å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç¬¬ä¸€å’Œç¬¬ä¸‰æ­¥éª¤ä¸­ä¼˜åŒ–æ€§èƒ½ã€‚
>
> æ¯”å¦‚è¯´ç›´æ¥ä½¿ç”¨ç¼“å­˜è€Œä¸å‘èµ·è¯·æ±‚ï¼Œæˆ–è€…å‘èµ·äº†è¯·æ±‚ä½†åç«¯å­˜å‚¨çš„æ•°æ®å’Œå‰ç«¯ä¸€è‡´ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å†å°†æ•°æ®å›ä¼ å›æ¥ï¼Œè¿™æ ·å°±å‡å°‘äº†å“åº”æ•°æ®ã€‚æœ¬åšæ–‡å°†é€šè¿‡ç¼“å­˜ä½ç½®ã€ç¼“å­˜ç­–ç•¥ä»¥åŠå®é™…åœºæ™¯åº”ç”¨ç¼“å­˜ç­–ç•¥æ¥æ€»ç»“ä¸€ä¸‹æµè§ˆå™¨ç¼“å­˜æœºåˆ¶ã€‚

## æ€ç»´å¯¼å›¾

![æµè§ˆå™¨ç¼“å­˜æœºåˆ¶](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-08-124444.png)



## ç¼“å­˜ä½ç½®

ä»ç¼“å­˜ä½ç½®ä¸Šæ¥åˆ†ç±»å¯ä»¥åˆ†æˆ 4 ç§ï¼Œå¹¶ä¸”å„è‡ªæœ‰å…¶ä¼˜å…ˆçº§ï¼Œå½“æˆ‘ä»¬æŒ¨ä¸ªæŸ¥æ‰¾ç¼“å­˜å‘ç°éƒ½æ²¡å‘½ä¸­ğŸ¯æ—¶æ‰ä¼šå‘èµ·è¯·æ±‚

- **Service Worker**
- **Memory Cache**
- **Disk Cache**
- **Push Cache**

### 1. Service Worker

service worker æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨èƒŒåçš„ç‹¬ç«‹å·¥ä½œçº¿ç¨‹ï¼Œä¸€èˆ¬å¯ä»¥ç”¨æ¥å®ç°ç¼“å­˜åŠŸèƒ½ã€‚ä½¿ç”¨ Service Worker çš„è¯ï¼Œä¼ è¾“åè®®å¿…é¡»ä¸º **HTTPS** ï¼å› ä¸º Service Worker ä¸­æ¶‰åŠåˆ°è¯·æ±‚æ‹¦æˆªï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨ HTTPS åè®®æ¥ä¿è¯å®‰å…¨ã€‚

**Service Worker çš„ç¼“å­˜ä¸æµè§ˆå™¨å…¶ä»–æœºåˆ¶ä¸åŒï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬è‡ªç”±æ§åˆ¶ç¼“å­˜å“ªäº›æ–‡ä»¶ã€å¦‚ä½•åŒ¹é…ç¼“å­˜ã€å¦‚ä½•è¯»å–ç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜æ˜¯æŒç»­æ€§çš„**ã€‚

è¦æƒ³å®ç°åˆ†ä¸‰æ­¥ï¼š

1. é¦–å…ˆéœ€è¦æ³¨å†Œ Service Worker
2. ç„¶åç›‘å¬åˆ° `install` äº‹ä»¶ä»¥åå°±å¯ä»¥ç¼“å­˜éœ€è¦çš„æ–‡ä»¶
3. åœ¨ä¸‹æ¬¡ç”¨æˆ·è®¿é—®çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡æ‹¦æˆªè¯·æ±‚çš„æ–¹å¼æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ç›¸åº”ç¼“å­˜ã€‚

> ä¸€ä¸ªæœ‰æ„æ€çš„æ˜¯ï¼š
>
> å½“ Service Worker æ²¡æœ‰å‘½ä¸­ç¼“å­˜çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç¼“å­˜æŸ¥æ‰¾çš„ä¼˜å…ˆçº§å»æŸ¥æ‰¾æ•°æ®ã€‚
>
> ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬æ˜¯ä» Memory Cache ä¸­è¿˜æ˜¯ä»ç½‘ç»œè¯·æ±‚ä¸­è·å–çš„æ•°æ®ï¼Œæµè§ˆå™¨éƒ½ä¼šæ˜¾ç¤ºæˆ‘ä»¬æ˜¯ä» Service Worker ä¸­è·å–çš„å†…å®¹ã€‚



### 2. Memory Cache

Memory Cache ä¹Ÿå°±æ˜¯å†…å­˜ä¸­çš„ç¼“å­˜ï¼Œä¸»è¦åŒ…å«çš„æ˜¯å½“å‰ä¸­é¡µé¢ä¸­å·²ç»æŠ“å–åˆ°çš„èµ„æº,ä¾‹å¦‚é¡µé¢ä¸Šå·²ç»ä¸‹è½½çš„æ ·å¼ã€è„šæœ¬ã€å›¾ç‰‡ç­‰ã€‚è¯»å–å†…å­˜ä¸­çš„æ•°æ®è‚¯å®šæ¯”ç£ç›˜å¿«ï¼Œå†…å­˜ç¼“å­˜è™½ç„¶è¯»å–é«˜æ•ˆï¼Œå¯æ˜¯ç¼“å­˜æŒç»­æ€§å¾ˆçŸ­ï¼Œä¼šéšç€è¿›ç¨‹çš„é‡Šæ”¾è€Œé‡Šæ”¾ã€‚ **ä¸€æ—¦æˆ‘ä»¬å…³é—­ Tab é¡µé¢ï¼Œå†…å­˜ä¸­çš„ç¼“å­˜ä¹Ÿå°±è¢«é‡Šæ”¾äº†**ã€‚

ç„¶è€Œè®¡ç®—æœºä¸­çš„å†…å­˜ä¸€å®šæ¯”ç¡¬ç›˜å®¹é‡å°å¾—å¤šï¼Œå†…å­˜çš„ä½¿ç”¨éœ€è¦ç²¾æ‰“ç»†ç®—ï¼Œæ‰€ä»¥èƒ½è®©æˆ‘ä»¬ä½¿ç”¨å¿…ç„¶ä¸å¤šã€‚

å½“æˆ‘ä»¬è®¿é—®è¿‡é¡µé¢ä»¥åï¼Œå†æ¬¡åˆ·æ–°é¡µé¢ï¼Œå¯ä»¥å‘ç°å¾ˆå¤šæ•°æ®éƒ½æ¥è‡ªäºå†…å­˜ç¼“å­˜ï¼š

![å†…å­˜ç¼“å­˜](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-07-125009.png)



### 3.Disk Cache

Disk Cache ä¹Ÿå°±æ˜¯å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­çš„ç¼“å­˜ï¼Œè¯»å–é€Ÿåº¦ç›¸å¯¹æ…¢ä¸€äº›ï¼Œä½†èƒ½å­˜å‚¨åˆ°ç£ç›˜ä¸­ï¼Œ**æ¯”ä¹‹ Memory Cache èƒœåœ¨å®¹é‡å’Œå­˜å‚¨æ—¶æ•ˆæ€§ä¸Š**ã€‚

åœ¨æ‰€æœ‰æµè§ˆå™¨ç¼“å­˜ä¸­ï¼ŒDisk Cache è¦†ç›–é¢åŸºæœ¬æ˜¯æœ€å¤§çš„ã€‚å®ƒä¼šæ ¹æ® HTTP Herder ä¸­çš„å­—æ®µåˆ¤æ–­å“ªäº›èµ„æºéœ€è¦ç¼“å­˜ï¼Œå“ªäº›èµ„æºå¯ä»¥ä¸è¯·æ±‚ç›´æ¥ä½¿ç”¨ï¼Œå“ªäº›èµ„æºå·²ç»è¿‡æœŸéœ€è¦é‡æ–°è¯·æ±‚ã€‚

å¹¶ä¸”å³ä½¿åœ¨è·¨ç«™ç‚¹çš„æƒ…å†µä¸‹ï¼Œç›¸åŒåœ°å€çš„èµ„æºä¸€æ—¦è¢«ç¡¬ç›˜ç¼“å­˜ä¸‹æ¥ï¼Œå°±ä¸ä¼šå†æ¬¡å»è¯·æ±‚æ•°æ®ã€‚ç»å¤§éƒ¨åˆ†çš„ç¼“å­˜éƒ½æ¥è‡ª Disk Cacheï¼Œå…³äº HTTP çš„åè®®å¤´ä¸­çš„ç¼“å­˜å­—æ®µï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹æ–‡è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚

**æµè§ˆå™¨ä¼šæŠŠå“ªäº›æ–‡ä»¶ä¸¢è¿›å†…å­˜ä¸­ï¼Ÿå“ªäº›ä¸¢è¿›ç¡¬ç›˜ä¸­ï¼Ÿ** å…³äºè¿™ç‚¹è¯´æ³•ä¸ä¸€ï¼Œä¸è¿‡ä»¥ä¸‹è§‚ç‚¹æ¯”è¾ƒé å¾—ä½ï¼š

- å¯¹äºå¤§æ–‡ä»¶æ¥è¯´ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œåä¹‹ä¼˜å…ˆ
- å½“å‰ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡é«˜çš„è¯ï¼Œæ–‡ä»¶ä¼˜å…ˆå­˜å‚¨è¿›ç¡¬ç›˜



### 4.Push Cache

Push Cacheï¼ˆæ¨é€ç¼“å­˜ï¼‰æ˜¯ HTTP/2 ä¸­çš„å†…å®¹ï¼Œå½“ä»¥ä¸Šä¸‰ç§ç¼“å­˜éƒ½æ²¡æœ‰å‘½ä¸­æ—¶ï¼Œå®ƒæ‰ä¼šè¢«ä½¿ç”¨ã€‚**å®ƒåªåœ¨ä¼šè¯ï¼ˆSessionï¼‰ä¸­å­˜åœ¨ï¼Œä¸€æ—¦ä¼šè¯ç»“æŸå°±è¢«é‡Šæ”¾ï¼Œå¹¶ä¸”ç¼“å­˜æ—¶é—´ä¹Ÿå¾ˆçŸ­æš‚**ï¼Œåœ¨ Chrome æµè§ˆå™¨ä¸­çº¦ 5 åˆ†é’Ÿå·¦å³ï¼ŒåŒæ—¶å®ƒä¹Ÿå¹¶éä¸¥æ ¼æ‰§è¡Œ HTTP å¤´ä¸­çš„ç¼“å­˜æŒ‡ä»¤ã€‚ç”±äºåœ¨å›½å†… HTTP/2 è¿˜ä¸ç®—éå¸¸æ™®åŠï¼Œè¿™ä¸€éƒ¨åˆ†çš„çŸ¥è¯†è¿˜éœ€è¦æ›´å¤šè°·æ­Œäº†è§£ ğŸ˜‚



## ç¼“å­˜è¿‡ç¨‹

æµè§ˆå™¨ä¸æœåŠ¡å™¨é€šä¿¡çš„æ–¹å¼ä¸ºï¼šæµè§ˆå™¨å‘èµ· HTTP è¯·æ±‚ â€“ æœåŠ¡å™¨å“åº”è¯¥è¯·æ±‚ï¼Œ**æµè§ˆå™¨æ€ä¹ˆç¡®å®šä¸€ä¸ªèµ„æºè¯¥ä¸è¯¥ç¼“å­˜ï¼Œå¦‚ä½•å»ç¼“å­˜å‘¢**ï¼Ÿ

æµè§ˆå™¨ç¬¬ä¸€æ¬¡å‘æœåŠ¡å™¨å‘èµ·è¯¥è¯·æ±‚åæ‹¿åˆ°è¯·æ±‚ç»“æœåï¼Œå°†è¯·æ±‚ç»“æœå’Œç¼“å­˜æ ‡è¯†å­˜å…¥æµè§ˆå™¨ç¼“å­˜ï¼Œ**æµè§ˆå™¨å¯¹äºç¼“å­˜çš„å¤„ç†æ˜¯æ ¹æ®ç¬¬ä¸€æ¬¡è¯·æ±‚èµ„æºæ—¶è¿”å›çš„å“åº”å¤´æ¥ç¡®å®šçš„**ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![ç¼“å­˜ä½•æ—¶æ‘](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-08-%E7%BC%93%E5%AD%98%E4%BD%95%E6%97%B6%E5%AD%98.png)

- æµè§ˆå™¨æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œ**éƒ½ä¼šå…ˆåœ¨æµè§ˆå™¨ç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥è¯·æ±‚çš„ç»“æœä»¥åŠç¼“å­˜æ ‡è¯†**
- æµè§ˆå™¨æ¯æ¬¡æ‹¿åˆ°è¿”å›ï¼Œ**è¯·æ±‚ç»“æœéƒ½ä¼šå°†è¯¥ç»“æœå’Œç¼“å­˜æ ‡è¯†å­˜å…¥æµè§ˆå™¨ç¼“å­˜ä¸­**

æˆ‘ä»¬æ ¹æ® **æ˜¯å¦éœ€è¦å‘æœåŠ¡å™¨é‡æ–°å‘èµ· HTTP è¯·æ±‚** ï¼Œå°†ç¼“å­˜è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ **å¼ºç¼“å­˜** å’Œ **åå•†ç¼“å­˜**ã€‚



### å¼ºç¼“å­˜

**ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–èµ„æºã€‚**

åœ¨ Chrome æ§åˆ¶å°çš„ `Network` é€‰é¡¹ä¸­å¯ä»¥çœ‹åˆ°è¯¥è¯·æ±‚è¿”å› `200` çš„çŠ¶æ€ç ï¼Œå¹¶ä¸” `Size` æ˜¾ç¤º `from disk cache` æˆ– `from memory cache` 

å¼ºç¼“å­˜å¯ä»¥é€šè¿‡è®¾ç½®ä¸¤ç§ HTTP Header å®ç°ï¼š`Expires` å’Œ `Cache-Control`:

#### Expires

**ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œç”¨æ¥æŒ‡å®šèµ„æºåˆ°æœŸçš„æ—¶é—´ï¼Œæ˜¯æœåŠ¡å™¨ç«¯çš„å…·ä½“çš„æ—¶é—´ç‚¹**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`Expires=max-age + è¯·æ±‚æ—¶é—´`ï¼Œéœ€è¦å’Œ `Last-modified` ç»“åˆä½¿ç”¨ã€‚`Expires` æ˜¯ Web æœåŠ¡å™¨å“åº”æ¶ˆæ¯å¤´å­—æ®µï¼Œåœ¨å“åº” HTTP è¯·æ±‚æ—¶å‘Šè¯‰æµè§ˆå™¨åœ¨è¿‡æœŸæ—¶é—´å‰æµè§ˆå™¨å¯ä»¥ç›´æ¥ä»æµè§ˆå™¨ç¼“å­˜å–æ•°æ®ï¼Œè€Œæ— éœ€å†æ¬¡è¯·æ±‚ã€‚

**Expires æ˜¯ HTTP/1 çš„äº§ç‰©ï¼Œå—é™äºæœ¬åœ°æ—¶é—´ï¼Œå¦‚æœä¿®æ”¹äº†æœ¬åœ°æ—¶é—´ï¼Œå¯èƒ½ä¼šé€ æˆç¼“å­˜å¤±æ•ˆ**ã€‚`Expires: Wed, 22 Oct 2018 08:41:00 GMT`è¡¨ç¤ºèµ„æºä¼šåœ¨ `Wed, 22 Oct 2018 08:41:00 GMT` åè¿‡æœŸï¼Œéœ€è¦å†æ¬¡è¯·æ±‚ã€‚



#### Cache-Control

æµè§ˆå™¨ç¼“å­˜é‡Œ, `Cache-Control` æ˜¯é‡‘å­—å¡”é¡¶å°–çš„è§„åˆ™ï¼Œå®ƒè—è§†ä¸€åˆ‡å…¶ä»–è®¾ç½®ï¼Œåªè¦å…¶ä»–è®¾ç½®ä¸å…¶æŠµè§¦ï¼Œä¸€å¾‹è¦†ç›–ä¹‹ã€‚ä¸ä»…å¦‚æ­¤, å®ƒè¿˜æ˜¯ä¸€ä¸ªå¤åˆè§„åˆ™ï¼ŒåŒ…å«å¤šç§å€¼ï¼Œæ¨ªè·¨ **å­˜å‚¨ç­–ç•¥**, **è¿‡æœŸç­–ç•¥** ä¸¤ç§ï¼ŒåŒæ—¶åœ¨è¯·æ±‚å¤´å’Œå“åº”å¤´éƒ½å¯è®¾ç½®ã€‚

è¯­æ³•ä¸º: *`Cache-Control: cache-directive`*.

`Cache-directive` å…±æœ‰å¦‚ä¸‹ 12 ç§ï¼Œå…¶ä¸­è¯·æ±‚ä¸­æŒ‡ä»¤ 7 ç§ï¼Œå“åº”ä¸­æŒ‡ä»¤ 9ç§ï¼š

|                Cache-directive                 |                             æè¿°                             | å­˜å‚¨ç­–ç•¥ | è¿‡æœŸç­–ç•¥ | è¯·æ±‚å­—æ®µ | å“åº”å­—æ®µ |
| :--------------------------------------------: | :----------------------------------------------------------: | :------: | :------: | -------- | -------- |
|                   **public**                   |                èµ„æºå°†è¢«å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨ç¼“å­˜                |    âœ”ï¸     |          |          | âœ”ï¸        |
|                  **private**                   |             èµ„æºä»…è¢«å®¢æˆ·ç«¯ç¼“å­˜, ä»£ç†æœåŠ¡å™¨ä¸ç¼“å­˜             |    âœ”ï¸     |          |          | âœ”ï¸        |
|                  **no-store**                  |                      è¯·æ±‚å’Œå“åº”éƒ½ä¸ç¼“å­˜                      |    âœ”ï¸     |          | âœ”ï¸        | âœ”ï¸        |
|                  **no-cache**                  | ç›¸å½“äº`max-age:0,must-revalidate`å³èµ„æºè¢«ç¼“å­˜, ä½†æ˜¯ç¼“å­˜ç«‹åˆ»è¿‡æœŸ, åŒæ—¶ä¸‹æ¬¡è®¿é—®æ—¶å¼ºåˆ¶éªŒè¯èµ„æºæœ‰æ•ˆæ€§ |    âœ”ï¸     |    âœ”ï¸     | âœ”ï¸        | âœ”ï¸        |
|                  **max-age**                   |         ç¼“å­˜èµ„æº, ä½†æ˜¯åœ¨æŒ‡å®šæ—¶é—´(å•ä½ä¸ºç§’)åç¼“å­˜è¿‡æœŸ         |    âœ”ï¸     |    âœ”ï¸     | âœ”ï¸        | âœ”ï¸        |
|                  **s-maxage**                  |  åŒä¸Š, ä¾èµ–publicè®¾ç½®, è¦†ç›–max-age, ä¸”åªåœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰æ•ˆ.  |    âœ”ï¸     |    âœ”ï¸     |          | âœ”ï¸        |
|                 **max-stale**                  |            æŒ‡å®šæ—¶é—´å†…, å³ä½¿ç¼“å­˜è¿‡æ—¶, èµ„æºä¾ç„¶æœ‰æ•ˆ            |          |    âœ”ï¸     | âœ”ï¸        |          |
|                 **min-fresh**                  |             ç¼“å­˜çš„èµ„æºè‡³å°‘è¦ä¿æŒæŒ‡å®šæ—¶é—´çš„æ–°é²œæœŸ             |          |    âœ”ï¸     | âœ”ï¸        |          |
| **must-revalidation** / **proxy-revalidation** | å¦‚æœç¼“å­˜å¤±æ•ˆ, å¼ºåˆ¶é‡æ–°å‘æœåŠ¡å™¨(æˆ–ä»£ç†)å‘èµ·éªŒè¯(å› ä¸ºmax-staleç­‰å­—æ®µå¯èƒ½æ”¹å˜ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´) |          |    âœ”ï¸     |          | âœ”ï¸        |
|               **only-if-cached**               |    ä»…ä»…è¿”å›å·²ç»ç¼“å­˜çš„èµ„æº, ä¸è®¿é—®ç½‘ç»œ, è‹¥æ— ç¼“å­˜åˆ™è¿”å›504     |          |          | âœ”ï¸        |          |
|                **no-transform**                | å¼ºåˆ¶è¦æ±‚ä»£ç†æœåŠ¡å™¨ä¸è¦å¯¹èµ„æºè¿›è¡Œè½¬æ¢, ç¦æ­¢ä»£ç†æœåŠ¡å™¨å¯¹ `Content-Encoding`, `Content-Range`, `Content-Type`å­—æ®µçš„ä¿®æ”¹(å› æ­¤ä»£ç†çš„gzipå‹ç¼©å°†ä¸è¢«å…è®¸) |          |          | âœ”ï¸        | âœ”ï¸        |

å‡è®¾æ‰€è¯·æ±‚èµ„æºäº 5 æœˆ 5 æ—¥ç¼“å­˜ï¼Œä¸”åœ¨ 5 æœˆ 12 æ—¥è¿‡æœŸã€‚å½“ `max-age` ä¸ `max-stale` å’Œ `min-fresh` åŒæ—¶ä½¿ç”¨æ—¶ï¼Œå®ƒä»¬çš„è®¾ç½®ç›¸äº’ä¹‹é—´ç‹¬ç«‹ç”Ÿæ•ˆï¼Œæœ€ä¸ºä¿å®ˆçš„ç¼“å­˜ç­–ç•¥æ€»æ˜¯æœ‰æ•ˆã€‚

 è¿™æ„å‘³ç€, å¦‚æœ `max-age=10 days`, `max-stale=2 days`, `min-fresh=3 days`ï¼š

é‚£ä¹ˆç”±äº **å®¢æˆ·ç«¯æ€»æ˜¯é‡‡ç”¨æœ€ä¿å®ˆçš„ç¼“å­˜ç­–ç•¥** ï¼Œå› æ­¤, 5 æœˆ 9 æ—¥å, å¯¹äºè¯¥èµ„æºçš„è¯·æ±‚å°†é‡æ–°å‘æœåŠ¡å™¨å‘èµ·éªŒè¯ã€‚

- æ ¹æ® `max-age` çš„è®¾ç½®, è¦†ç›–åŸç¼“å­˜å‘¨æœŸ,  ç¼“å­˜èµ„æºå°†åœ¨ 5 æœˆ 15 æ—¥å¤±æ•ˆ (`5+10=15`)

- æ ¹æ® `max-stale` çš„è®¾ç½®ï¼Œç¼“å­˜è¿‡æœŸåä¸¤å¤©ä¾ç„¶æœ‰æ•ˆï¼Œæ­¤æ—¶å“åº”å°†è¿”å› `110(Response is stale)` çŠ¶æ€ç , ç¼“å­˜èµ„æºå°†åœ¨ 5 æœˆ 14 æ—¥å¤±æ•ˆ (`12+2=14`)

- æ ¹æ® `min-fresh` çš„è®¾ç½®, è‡³å°‘è¦ç•™æœ‰ 3 å¤©çš„æ–°é²œæœŸ, ç¼“å­˜èµ„æºå°†åœ¨ 5æœˆ9æ—¥å¤±æ•ˆ (`12-3=9`)

  `min-fresh` çš„è¿‡ç¨‹å¯ä»¥è¿™æ ·æ¥çœ‹ï¼š

  ![min-fresh](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-08-F3542C7F-C3A1-4B24-9B1A-1E1E56B46E23.png)
  
  ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªæŒ‡ä»¤é…åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ï¼Œè¾¾åˆ°å¤šä¸ªç›®çš„ï¼šæ¯”å¦‚è¯´æˆ‘ä»¬å¸Œæœ›å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨éƒ½èƒ½ç¼“å­˜ï¼Œè¿˜èƒ½è®¾ç½®ç¼“å­˜å¤±æ•ˆæ—¶é—´ç­‰ç­‰ã€‚



#### Expires å’Œ Cache-Control ä¸¤è€…å¯¹æ¯”

å…¶å®è¿™ä¸¤è€…å·®åˆ«ä¸å¤§ï¼ŒåŒºåˆ«å°±åœ¨äº Expires æ˜¯http1.0çš„äº§ç‰©ï¼ŒCache-Controlæ˜¯http1.1çš„äº§ç‰©ï¼Œ**ä¸¤è€…åŒæ—¶å­˜åœ¨çš„è¯ï¼ŒCache-Controlä¼˜å…ˆçº§é«˜äºExpires**ï¼›åœ¨æŸäº›ä¸æ”¯æŒHTTP1.1çš„ç¯å¢ƒä¸‹ï¼ŒExpireså°±ä¼šå‘æŒ¥ç”¨å¤„ã€‚æ‰€ä»¥Expireså…¶å®æ˜¯è¿‡æ—¶çš„äº§ç‰©ï¼Œç°é˜¶æ®µå®ƒçš„å­˜åœ¨åªæ˜¯ä¸€ç§å…¼å®¹æ€§çš„å†™æ³•ã€‚
å¼ºç¼“å­˜åˆ¤æ–­æ˜¯å¦ç¼“å­˜çš„ä¾æ®æ¥è‡ªäºæ˜¯å¦è¶…å‡ºæŸä¸ªæ—¶é—´æˆ–è€…æŸä¸ªæ—¶é—´æ®µï¼Œè€Œä¸å…³å¿ƒæœåŠ¡å™¨ç«¯æ–‡ä»¶æ˜¯å¦å·²ç»æ›´æ–°ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´åŠ è½½æ–‡ä»¶ä¸æ˜¯æœåŠ¡å™¨ç«¯æœ€æ–°çš„å†…å®¹ï¼Œ**é‚£æˆ‘ä»¬å¦‚ä½•è·çŸ¥æœåŠ¡å™¨ç«¯å†…å®¹æ˜¯å¦å·²ç»å‘ç”Ÿäº†æ›´æ–°å‘¢**ï¼Ÿæ­¤æ—¶æˆ‘ä»¬éœ€è¦ç”¨åˆ°åå•†ç¼“å­˜ç­–ç•¥ã€‚



### åå•†ç¼“å­˜

**å¼ºåˆ¶ç¼“å­˜å¤±æ•ˆåï¼Œæµè§ˆå™¨æºå¸¦ç¼“å­˜æ ‡è¯†å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œç”±æœåŠ¡å™¨æ ¹æ®ç¼“å­˜æ ‡è¯†å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„è¿‡ç¨‹ã€‚**ï¼š

ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

1. åå•†ç¼“å­˜ç”Ÿæ•ˆï¼Œè¿”å› `304 Not Modified`

   ![åå•†ç¼“å­˜æœºåˆ¶](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-08-%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6.png)

2. åå•†ç¼“å­˜å¤±æ•ˆï¼Œè¿”å› `200` å’Œè¯·æ±‚ç»“æœï¼Œç„¶åå°†è¯·æ±‚ç»“æœå’Œç¼“å­˜æ ‡ç¤ºå­˜å…¥æµè§ˆå™¨ç¼“å­˜ä¸­

åå•†ç¼“å­˜å¯ä»¥é€šè¿‡è®¾ç½®ä¸¤ç§ HTTP Header å®ç°ï¼š`Last-Modified` å’Œ `ETag` ï¼š



#### Last-Modified ä¸ If-Modified-Since

è¯­æ³•: *`Last-Modified: æ˜ŸæœŸ,æ—¥æœŸ æœˆä»½ å¹´ä»½ æ—¶:åˆ†:ç§’ GMT`*

```
Last-Modified: Tue, 04 Apr 2017 10:01:15 GMT
```

ç”¨äºæ ‡è®°è¯·æ±‚èµ„æºçš„æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´ï¼Œæ ¼å¼ä¸º **GMT(æ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´)** ã€‚ å¦‚å¯ç”¨ `new Date().toGMTString()`è·å–å½“å‰ GMT æ—¶é—´ã€‚ `Last-Modified` æ˜¯ `ETag` çš„ `fallback` æœºåˆ¶ï¼Œä¼˜å…ˆçº§æ¯” `ETag` ä½ï¼Œä¸”åªèƒ½ç²¾ç¡®åˆ°ç§’ã€‚



```
If-Modified-Since: Tue, 04 Apr 2017 10:12:27 GMT
```

`If-Modified-Since`æ˜¯ä¸€ä¸ªç¼“å­˜æ ¡éªŒå­—æ®µï¼Œè¯­æ³•åŒä¸Šï¼Œå…¶å€¼ä¸ºä¸Šæ¬¡å“åº”å¤´çš„ `Last-Modified` å€¼ï¼Œè‹¥ä¸è¯·æ±‚èµ„æºå½“å‰çš„ `Last-Modified` å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°†è¿”å› `304` çŠ¶æ€ç çš„å“åº”ï¼Œåä¹‹ï¼Œå°†è¿”å› `200` çŠ¶æ€ç å“åº”ã€‚

**ä½†æ˜¯ Last-Modified å­˜åœ¨ä¸€äº›å¼Šç«¯ï¼š**

- å¦‚æœæœ¬åœ°æ‰“å¼€ç¼“å­˜æ–‡ä»¶ï¼Œå³ä½¿æ²¡æœ‰å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œä½†è¿˜æ˜¯ä¼šé€ æˆ `Last-Modified` è¢«ä¿®æ”¹ï¼ŒæœåŠ¡ç«¯ä¸èƒ½å‘½ä¸­ç¼“å­˜å¯¼è‡´å‘é€ç›¸åŒçš„èµ„æºã€‚
- ä¸å¤ªé€‚åˆçŸ­æ—¶é—´å†…é¢‘ç¹æ”¹åŠ¨çš„èµ„æºï¼Œæ¯”å¦‚æœ‰äº›æœåŠ¡ç«¯çš„é™æ€èµ„æºé€šå¸¸éœ€è¦ç¼–è¯‘æ‰“åŒ…ï¼Œä¹Ÿå¯èƒ½å‡ºç°èµ„æºå†…å®¹æ²¡æœ‰æ”¹å˜ï¼Œè€Œ `Last-Modified` å´æ”¹å˜çš„æƒ…å†µã€‚
- å› ä¸º `Last-Modified` åªèƒ½ä»¥ç§’è®¡æ—¶ï¼Œå¦‚æœåœ¨ä¸å¯æ„ŸçŸ¥çš„æ—¶é—´å†…ä¿®æ”¹å®Œæˆæ–‡ä»¶ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¼šè®¤ä¸ºèµ„æºè¿˜æ˜¯å‘½ä¸­äº†ï¼Œä¸ä¼šè¿”å›æ­£ç¡®çš„èµ„æº



> å¦å¤–è¿˜æœ‰ `If-Unmodified-Since`ï¼š
>
> ä¹Ÿæ˜¯ä¸€ä¸ªç¼“å­˜æ ¡éªŒå­—æ®µï¼Œè¡¨ç¤ºèµ„æºæœªä¿®æ”¹åˆ™æ­£å¸¸æ‰§è¡Œæ›´æ–°ï¼Œå¦åˆ™è¿”å› `412 Precondition Failed` çŠ¶æ€ç çš„å“åº”. å¸¸ç”¨äºå¦‚ä¸‹ä¸¤ç§åœºæ™¯ï¼š
>
> - æœ‰ä¸€å®šäº‹åŠ¡æ€§çš„è¯·æ±‚, æ¯”å¦‚è¯´ä½¿ç”¨ POST è¯·æ±‚æ›´æ–° wiki æ–‡æ¡£, æ–‡æ¡£æœªä¿®æ”¹æ—¶æ‰æ‰§è¡Œæ›´æ–°ã€‚
>- ä¸ `If-Range` å­—æ®µåŒæ—¶ä½¿ç”¨æ—¶, å¯ä»¥ç”¨æ¥ä¿è¯æ–°çš„ç‰‡æ®µè¯·æ±‚æ¥è‡ªä¸€ä¸ªæœªä¿®æ”¹çš„æ–‡æ¡£.



æ—¢ç„¶æ ¹æ®æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ¥å†³å®šæ˜¯å¦ç¼“å­˜å°šæœ‰ä¸è¶³ï¼Œèƒ½å¦å¯ä»¥ç›´æ¥æ ¹æ®æ–‡ä»¶å†…å®¹æ˜¯å¦ä¿®æ”¹æ¥å†³å®šç¼“å­˜ç­–ç•¥ï¼Ÿæ‰€ä»¥åœ¨ HTTP / 1.1 å‡ºç°äº† `ETag` å’Œ`If-None-Match`



#### ETag å’Œ If-None-Match

**`ETag` æ˜¯æœåŠ¡å™¨å“åº”è¯·æ±‚æ—¶ï¼Œè¿”å›å½“å‰èµ„æºæ–‡ä»¶çš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ˆç”±æœåŠ¡å™¨ç”Ÿæˆï¼‰ï¼Œåªè¦èµ„æºæœ‰å˜åŒ–ï¼Œ`ETag` å°±ä¼šé‡æ–°ç”Ÿæˆ**ã€‚

æµè§ˆå™¨åœ¨ä¸‹ä¸€æ¬¡åŠ è½½èµ„æºå‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šå°†ä¸Šä¸€æ¬¡è¿”å›çš„ `ETag` å€¼æ”¾åˆ° Request Header é‡Œçš„ `If-None-Match` é‡Œï¼ŒæœåŠ¡å™¨åªéœ€è¦æ¯”è¾ƒå®¢æˆ·ç«¯ä¼ æ¥çš„ `If-None-Match` è·Ÿè‡ªå·±æœåŠ¡å™¨ä¸Šè¯¥èµ„æºçš„ `ETag` æ˜¯å¦ä¸€è‡´ï¼Œå°±èƒ½å¾ˆå¥½åœ°åˆ¤æ–­èµ„æºç›¸å¯¹å®¢æˆ·ç«¯è€Œè¨€æ˜¯å¦è¢«ä¿®æ”¹è¿‡äº†ã€‚

- å¦‚æœæœåŠ¡å™¨å‘ç° `ETag` åŒ¹é…ä¸ä¸Šï¼Œé‚£ä¹ˆç›´æ¥ä»¥å¸¸è§„ `GET 200` å›åŒ…å½¢å¼å°†æ–°çš„èµ„æºï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬äº†æ–°çš„ `ETag` ï¼‰å‘ç»™å®¢æˆ·ç«¯ï¼›

- å¦‚æœ `ETag` æ˜¯ä¸€è‡´çš„ï¼Œåˆ™ç›´æ¥è¿”å› `304` çŸ¥ä¼šå®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜å³å¯ã€‚



#### Last-Modified ä¸ ETag çš„å¯¹æ¯”

- é¦–å…ˆåœ¨ç²¾ç¡®åº¦ä¸Šï¼Œ`ETag` è¦ä¼˜äº `Last-Modified`ã€‚

  `Last-Modified` çš„æ—¶é—´å•ä½æ˜¯ **ç§’**ï¼Œå¦‚æœæŸä¸ªæ–‡ä»¶åœ¨ 1 ç§’å†…æ”¹å˜äº†å¤šæ¬¡ï¼Œé‚£ä¹ˆä»–ä»¬çš„ `Last-Modified` å…¶å®å¹¶æ²¡æœ‰ä½“ç°å‡ºæ¥ä¿®æ”¹ï¼Œä½†æ˜¯ `ETag` æ¯æ¬¡éƒ½ä¼šæ”¹å˜ç¡®ä¿äº†ç²¾åº¦ï¼›

  å¦‚æœæ˜¯è´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨ï¼Œå„ä¸ªæœåŠ¡å™¨ç”Ÿæˆçš„ `Last-Modified` ä¹Ÿæœ‰å¯èƒ½ä¸ä¸€è‡´ã€‚

- ç¬¬äºŒåœ¨æ€§èƒ½ä¸Šï¼Œ`ETag` è¦é€Šäº `Last-Modified`ï¼Œæ¯•ç«Ÿ `Last-Modified` åªéœ€è¦è®°å½•æ—¶é—´ï¼Œè€Œ `ETag` éœ€è¦æœåŠ¡å™¨é€šè¿‡ç®—æ³•æ¥è®¡ç®—å‡ºä¸€ä¸ª hash å€¼ã€‚
- ç¬¬ä¸‰åœ¨ä¼˜å…ˆçº§ä¸Šï¼ŒæœåŠ¡å™¨æ ¡éªŒä¼˜å…ˆè€ƒè™‘ `ETag`



## ç¼“å­˜æœºåˆ¶

1. å¼ºåˆ¶ç¼“å­˜ä¼˜å…ˆäºåå•†ç¼“å­˜è¿›è¡Œã€‚
2. è‹¥å¼ºåˆ¶ç¼“å­˜ `Expires` å’Œ `Cache-Control` ç”Ÿæ•ˆåˆ™ç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚
3. è‹¥ä¸ç”Ÿæ•ˆåˆ™è¿›è¡Œåå•†ç¼“å­˜ `Last-Modified` / `If-Modified-Since` å’Œ `ETag` / `If-None-Match`ï¼Œåå•†ç¼“å­˜ç”±æœåŠ¡å™¨å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜
   - è‹¥åå•†ç¼“å­˜å¤±æ•ˆï¼Œé‚£ä¹ˆé‡æ–°è¯·æ±‚ï¼Œè¿”å› 200ï¼Œå°†è¿”å›çš„èµ„æºå’Œç¼“å­˜æ ‡ç¤ºé‡æ–°å­˜å…¥æµè§ˆå™¨ç¼“å­˜ä¸­ï¼›
   - ç”Ÿæ•ˆåˆ™è¿”å› 304ï¼Œç»§ç»­ä½¿ç”¨ç¼“å­˜ã€‚å…·ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼›

![ç¼“å­˜æœºåˆ¶](http://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-05-08-B24E8CF1-E622-4F15-ABDC-8E6CDC70B7FC.png)

> **æµç¨‹å›¾æ¥è‡ªï¼šè·¯æ˜“æ–¯**æ¥æºï¼šæ˜é‡‘ï¼Œæ­¤å›¾è‘—ä½œæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚

## References

1. [æµè§ˆå™¨ç¼“å­˜æœºåˆ¶å‰–æ](https://juejin.im/post/58eacff90ce4630058668257#heading-1)

2. [å½»åº•ç†è§£æµè§ˆå™¨çš„ç¼“å­˜æœºåˆ¶](https://mp.weixin.qq.com/s?__biz=MjM5MTA1MjAxMQ==&mid=2651228395&idx=1&sn=dcf7e3bd518f1e189ce17eaed94c27bb&chksm=bd49516f8a3ed879221bf28bf68ac00c4733a6048c54ea90e75a9e2315a262c2d66fb29a4a34&mpshare=1&scene=1&srcid=0419jU32MPcOkcBWJJVdgj2J#rd)

3. [å‰ç«¯é¢è¯•ä¹‹é“](https://juejin.im/book/5bdc715fe51d454e755f75ef/section/5c024ecbf265da616a476638)

