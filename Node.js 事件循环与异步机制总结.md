# Node.js äº‹ä»¶å¾ªç¯ä¸å¼‚æ­¥æœºåˆ¶æ€»ç»“

> **è§‰å¦‚çš„å¸¸è§„å” å¨æ—¶é—´ï¼š**
>
> è¿™æ˜¯æŠŠä»¥å‰å‡ ç« çš„å­¦ä¹ æ€»ç»“æˆä¸€æ–‡ ...
>
> å­¦ä¹  JavaScript çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»å†äº†ä¸€ä¸ªæ¢ç§˜è¿‡ç¨‹æ˜¯ï¼šä»`Promise` åˆ° `async/await`ï¼Œæœ€åæˆ‘å‘ç°ã€Œ**å¼‚æ­¥**ã€è¿™äº›ä¸ªé—®é¢˜éƒ½æºè‡ªäº JS çš„çº¿ç¨‹æ¨¡å‹ã€‚
>
> æˆ‘ä»¬éƒ½çŸ¥é“ JavaScript æ˜¯ä¸€é—¨å•çº¿ç¨‹çš„è¯­è¨€ï¼Œåƒæˆ‘ä»¬è¿™æ ·çš„å¾ˆå¤šç¼–ç¨‹åˆå­¦è€…åˆšå¼€å§‹å†™çš„ä»£ç ï¼Œéƒ½æ˜¯ä¸€ä»¶äº‹æ¥ç€ä¸€ä»¶äº‹åšï¼Œæ˜¯ã€Œ**åŒæ­¥**ã€çš„é€»è¾‘ï¼Œä½†æ˜¯åœ¨é‡åˆ°è¾ƒé«˜å¹¶å‘åœºæ™¯æ—¶ï¼Œå¦‚æœé¡ºæ¬¡è¿›è¡Œï¼Œä»»åŠ¡å°±ä¼šæ’èµ·é•¿é˜Ÿ ...
>
> è¿™äº›ä»»åŠ¡ä¸­ï¼Œæœ‰çš„æ˜¯ç”¨ CPU çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ‰§è¡Œèµ·æ¥ç›¸å¯¹è¾ƒå¿«ï¼Œè€Œæœ‰çš„æ˜¯ I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œç›¸å¯¹è¾ƒæ…¢ï¼Œå¦‚æœ
>
> é˜…è¯» Node.js çš„å®˜æ–¹æ–‡æ¡£ï¼Œä½ ä¼šæƒŠè®¶äºå‡ ä¹å®ƒçš„æ¯ä¸€ä¸ª API éƒ½å¸¦æœ‰ã€Œ**å›è°ƒå‡½æ•°**ã€ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨ API çš„åŠŸèƒ½æ‰§è¡Œå®Œæˆåæ‰è¢«è°ƒç”¨çš„ã€‚
>
> æ­£æ˜¯å› ä¸ºå¹¶å‘ã€å¤šçº¿ç¨‹è¿™æ ·çš„ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä½œä¸ºç¨‹åºå‘˜å¯¹å„ä¸ªä»»åŠ¡æ‰§è¡Œçš„æƒ…å†µå¾ˆéš¾å‡†ç¡®æŠŠæ§ï¼Œåšä¸åˆ°å¾ˆå¥½çš„ä»»åŠ¡è°ƒåº¦å®‰æ’ï¼Œæ‰€ä»¥æ‰è¯´ "å¹¶å‘çš„å­¦ä¹ æ˜¯éš¾ç‚¹"ã€‚
>
> è€Œ "å›è°ƒ" è¿™ç§ã€Œ**é¢„ç½®æœªæ¥**ã€çš„æ–¹æ¡ˆå¤§å¤§æ–¹ä¾¿äº†æˆ‘ä»¬ï¼Œç¨‹åºçš„ä¸»ä½“é€»è¾‘å¼€å§‹å˜å¾—æ¸…æ™°è€Œç²¾ç‚¼ã€‚
>
> è¯¦æƒ…è¯·æ¥ç€çœ‹ä¸‹å»å§ï¼

å¦‚æœä½ åˆšå¼€å§‹å­¦ä¹  Node.jsï¼Œä½ ä¸€å®šä¼šçœ‹åˆ°è®¸å¤šä»‹ç»ä¸­è¿™æ ·å†™ï¼šã€Œ **å¼‚æ­¥ã€éé˜»å¡çš„ I/O** ã€ï¼ŒçŸ¥ä¹ä¸Šæœ‰ä¸ªç‰¹åˆ«å½¢è±¡çš„ä¾‹å­ï¼Œæˆ‘åœ¨è¿™é‡Œå¼•ç”¨è¿‡æ¥ï¼š

>è€å¼ çˆ±å–èŒ¶ï¼ŒåºŸè¯ä¸è¯´ï¼Œç…®å¼€æ°´ã€‚
>å‡ºåœºäººç‰©ï¼šè€å¼ ï¼Œæ°´å£¶ä¸¤æŠŠï¼ˆæ™®é€šæ°´å£¶ï¼Œç®€ç§°æ°´å£¶ï¼›ä¼šå“çš„æ°´å£¶ï¼‰ã€‚
>1. è€å¼ æŠŠæ°´å£¶æ”¾åˆ°ç«ä¸Šï¼Œç«‹ç­‰æ°´å¼€ã€‚ï¼ˆ**åŒæ­¥é˜»å¡**ï¼‰
>è€å¼ è§‰å¾—è‡ªå·±æœ‰ç‚¹å‚»
>2. è€å¼ æŠŠæ°´å£¶æ”¾åˆ°ç«ä¸Šï¼Œå»å®¢å…çœ‹ç”µè§†ï¼Œæ—¶ä¸æ—¶å»å¨æˆ¿çœ‹çœ‹æ°´å¼€æ²¡æœ‰ã€‚ï¼ˆ**åŒæ­¥éé˜»å¡**ï¼‰
>è€å¼ è¿˜æ˜¯è§‰å¾—è‡ªå·±æœ‰ç‚¹å‚»ï¼Œäºæ˜¯å­¦èªæ˜äº†ï¼Œä¹°äº†ä¼šå“ç¬›çš„é‚£ç§æ°´å£¶ã€‚æ°´å¼€åèƒ½å¤§å£°å‘å‡º "å˜€â”€â”€" çš„å™ªéŸ³ã€‚
>3. è€å¼ æŠŠå“æ°´å£¶æ”¾åˆ°ç«ä¸Šï¼Œç«‹ç­‰æ°´å¼€ã€‚ï¼ˆ**å¼‚æ­¥é˜»å¡**ï¼‰
>è€å¼ è§‰å¾—è¿™æ ·å‚»ç­‰æ„ä¹‰ä¸å¤§
>4. è€å¼ æŠŠå“æ°´å£¶æ”¾åˆ°ç«ä¸Šï¼Œå»å®¢å…çœ‹ç”µè§†ï¼Œæ°´å£¶å“ä¹‹å‰ä¸å†å»çœ‹å®ƒäº†ï¼Œå“äº†å†å»æ‹¿å£¶ã€‚ï¼ˆ**å¼‚æ­¥éé˜»å¡**ï¼‰
>è€å¼ è§‰å¾—è‡ªå·±èªæ˜å¤šäº†ã€‚
>
>
>
>ä½œè€…ï¼šã€Œ**æ„šæŠ„**ã€
>é“¾æ¥ï¼šhttpss://www.zhihu.com/question/19732473/answer/23434554
>æ¥æºï¼šçŸ¥ä¹

ä½†å¹¶ä¸æ˜¯è¯´åªè¦ä½ ç”¨äº†å›è°ƒå‡½æ•°ï¼Œç¨‹åºå°±å¼‚æ­¥åŒ–äº†ï¼Œ"å›è°ƒå‡½æ•°" æœ¬èº«åªæ˜¯ä¸€ç§å®ç°æ‰‹æ®µè€Œå·²ã€‚

ä½ å¯èƒ½ä¼šè¯´ï¼š" é‚£è¿™ä¸ªå°±ç®€å•äº†ï¼Œæˆ‘çŸ¥é“å›è°ƒä»€ä¹ˆæ—¶å€™ç”¨ï¼ŒNode.js é‡Œä¸€å®šæ˜¯æŠŠ `callback(...args)` æ”¾åœ¨é‚£ä¸ª API å®ç°çš„æœ€åã€‚" ä¸è¿‡çœŸçš„æ˜¯è¿™æ ·ä¹ˆï¼Ÿå¦‚æœå®ƒä¹‹å‰çš„ä»£ç å¾ˆè€—æ—¶ï¼Œæ•´ä¸ªç¨‹åºå²‚ä¸æ˜¯åˆè¢«å¡ä½äº†ï¼Ÿ

æ‰€ä»¥é‡ç‚¹æ ¹æœ¬ä¸æ˜¯å›è°ƒï¼Œè€Œæ˜¯ Node.js é‡‡ç”¨äº†ã€Œ**äº‹ä»¶é©±åŠ¨**ã€ã€‚

Node.js æ‰€æœ‰çš„å¼‚æ­¥ I/O æ“ä½œéƒ½ä¼šå…ˆç”Ÿæˆä¸€ä¸ªäº‹ä»¶ç›‘å¬è€…ï¼Œåœ¨å®Œæˆæ—¶éƒ½ä¼šå‘å›ä¸€ä¸ªç›¸åº”çš„äº‹ä»¶åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼Œç„¶åäº‹ä»¶ç›‘å¬è€…æ‰å»æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

```js
// å¼•å…¥ events æ¨¡å—
var events = require('events');
// åˆ›å»º eventEmitter å¯¹è±¡
var eventEmitter = new events.EventEmitter();
 
// åˆ›å»ºäº‹ä»¶å¤„ç†ç¨‹åº
var connectHandler = function connected() {
   console.log('è¿æ¥æˆåŠŸã€‚');
  
   // è§¦å‘ data_received äº‹ä»¶ 
   eventEmitter.emit('data_received');
}
 
// ç»‘å®š connection äº‹ä»¶å¤„ç†ç¨‹åº
eventEmitter.on('connection', connectHandler);
 
// ä½¿ç”¨åŒ¿åå‡½æ•°ç»‘å®š data_received äº‹ä»¶
eventEmitter.on('data_received', function(){
   console.log('æ•°æ®æ¥æ”¶æˆåŠŸã€‚');
});
 
// è§¦å‘ connection äº‹ä»¶ 
eventEmitter.emit('connection');
 
console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚");
```

```bash
> node main.js
è¿æ¥æˆåŠŸã€‚
æ•°æ®æ¥æ”¶æˆåŠŸã€‚
ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚
```

åœ¨ Node.js å¯åŠ¨çš„æ—¶å€™ï¼Œæ­¥éª¤åˆ†åˆ«æ˜¯ï¼š

1. åˆå§‹åŒ–äº‹ä»¶å¾ªç¯

2. å¤„ç†å¯èƒ½åŒ…å«å¼‚æ­¥ API è°ƒç”¨çš„è¾“å…¥è„šæœ¬ï¼ˆç”¨æˆ·ä»£ç ï¼‰æˆ–è¿›å…¥ [Node REPL](httpss://link.jianshu.com?t=httpss://nodejs.org/api/repl.html#repl_repl)

3. æ‰§è¡Œå¼‚æ­¥ API çš„å›è°ƒã€è°ƒåº¦å®šæ—¶å™¨æˆ–è€…è°ƒç”¨ `process.nextTick()` 

   å¦‚æ­¤å¾ªç¯å¾€å¤ ...

```bash
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚          timers å®šæ—¶å™¨        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ pending callbacks  ç­‰å¾…çš„å›è°ƒ  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚          idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:     â”‚
â”‚  â”‚           poll  è½®è¯¢          â”‚<â”€â”€â”€â”€â”¤  connections,   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚             check            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤ close callbacks å…³é—­ç±»äº‹ä»¶çš„å›è°ƒ  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

*æ³¨æ„ï¼šæ¯ä¸ªæ–¹æ¡†éƒ½ç§°ä¸ºäº‹ä»¶å¾ªç¯çš„â€œ**é˜¶æ®µ**â€ã€‚*

æ¯ä¸€é˜¶æ®µéƒ½æœ‰ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å¾…æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ã€‚è€Œåœ¨æ¯ä¸€é˜¶æ®µå†…éƒ¨æœ‰è‡ªå·±çš„æ‰§è¡Œæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è¿›å…¥å…¶ä¸­ä¸€ä¸ªé˜¶æ®µæ—¶ï¼Œä¼šæ‰§è¡Œä»»ä½•è¯¥é˜¶æ®µè‡ªå·±ç‰¹å®šçš„æ“ä½œï¼Œç„¶åæ‰æ‰§è¡Œåœ¨è¯¥é˜¶æ®µçš„é˜Ÿåˆ—ä¸­çš„å›è°ƒï¼Œç›´åˆ°é˜Ÿåˆ—é‡Œçš„å›è°ƒéƒ½æ‰§è¡Œå®Œäº†æˆ–æ‰§è¡Œçš„æ¬¡æ•°è¾¾åˆ°æœ€å¤§é™åˆ¶ã€‚å½“é˜Ÿåˆ—è€—å°½æˆ–æ‰§è¡Œçš„æ¬¡æ•°è¾¾åˆ°æœ€å¤§é™åˆ¶æ—¶ï¼Œäº‹ä»¶å¾ªç¯è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œå¦‚æ­¤å¾ªç¯ã€‚

**å®šæ—¶å™¨**ï¼šè¿™ä¸€é˜¶æ®µæ‰§è¡Œç”± `setTimeout()` å’Œ `setInterval()` è®¾ç½®çš„å›è°ƒã€‚
 **I/O å›è°ƒ**ï¼šæ‰§è¡Œé™¤å…³é—­å›è°ƒã€å®šæ—¶å™¨è°ƒåº¦çš„å›è°ƒå’Œ `setImmediat()` ä»¥å¤–çš„å‡ ä¹æ‰€æœ‰çš„å›è°ƒã€‚
 **ideï¼Œprepare**ï¼šä»…å†…éƒ¨ä½¿ç”¨ã€‚
 **è½®è¯¢**ï¼šè·å–æ–°çš„ I/O äº‹ä»¶ï¼›é€‚å½“çš„æ—¶å€™è¿™é‡Œä¼šè¢«é˜»æ–­ã€‚
 **check**ï¼š `setImmediate()` çš„å›è°ƒã€‚
 **å…³é—­äº‹ä»¶å›è°ƒ**ï¼šå¦‚ `socket.on('close', ...)` çš„å›è°ƒã€‚

åœ¨äº‹ä»¶å¾ªç¯çš„æ¯æ¬¡è¿è¡Œä¹‹é—´ï¼Œ Node.js ä¼šæ£€æŸ¥æ˜¯å¦åœ¨ç­‰å¾…ä»»ä½•å¼‚æ­¥ I/O æˆ–å®šæ—¶å™¨ï¼Œå¦‚æœä¸¤ä¸ªéƒ½æ²¡æœ‰å°±è‡ªåŠ¨å…³é—­ã€‚



## å„é˜¶æ®µè¯¦è§£

### 1 å®šæ—¶å™¨ Timers

```js
const fs = require('fs');

// å‡½æ•° 1:
function someAsyncOperation(callback) {
  // å‡è®¾ è¿™ä¸ªè¯»å–è¦èŠ±è´¹ 95ms
  fs.readFile('/path/to/file', callback);
}

const timeoutScheduled = Date.now();

setTimeout(() => { // å›è°ƒ 1
  const delay = Date.now() - timeoutScheduled;

  console.log(`è‡ªä»æˆ‘è¢«è°ƒåº¦ï¼Œå·²ç»è¿‡å»äº†${delay}ms`);
}, 100);

someAsyncOperation(() => { // å›è°ƒ 2
  const startCallback = Date.now();

  // åšç‚¹ä»€ä¹ˆï¼Œæ¥æ¶ˆè€— 10ms
  while (Date.now() - startCallback < 10) {
		// è®©å¾ªç¯è·‘ç€å°±å¥½...
  }
});

// æ‰“å°å‡ºç»“æœï¼šè‡ªä»æˆ‘è¢«è°ƒåº¦ï¼Œå·²ç»è¿‡å»äº†105ms
```

ä½ æ˜¯ä¸æ˜¯è¿™ä¹ˆé¢„æµ‹çš„ï¼š

1. å‡½æ•° 1ï¼š`0 ~ 95ms` 
2. å›è°ƒ 1ï¼š`100ms +`
3. å›è°ƒ 2ï¼š`105ms`

å½“äº‹ä»¶å¾ªç¯è¿›å…¥è½®è¯¢é˜¶æ®µï¼Œä»»åŠ¡é˜Ÿåˆ—è¿˜æ˜¯ç©ºçš„ï¼ˆ å› ä¸º`fs.readFile()` è¿˜æ²¡æ‰§è¡Œå®Œï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå¼€å§‹ä¸€ç›´å¾ªç¯ï¼Œç­‰å¾… `fs.readFile()` æ‰§è¡Œå®Œåæœ‰ä¸€ä¸ªå®šæ—¶å™¨è¾¾åˆ°é˜ˆå€¼ã€‚

è¿™é‡Œ `95ms` æœ€å¿«åˆ°è¾¾ï¼Œå³æ–‡ä»¶å…ˆè¯»å®Œç„¶åå›è°ƒæ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—å¹¶å¼€å§‹æ‰§è¡Œï¼Œç„¶è€Œè¯¥å›è°ƒä»»åŠ¡éœ€è¦èŠ±è´¹ `10ms` æ¥æ‰§è¡Œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯åœ¨å½“å‰è¿™è½®å¾ªç¯çš„ `pending callbacks` é˜¶æ®µ

åœ¨æ‰§è¡Œå®Œè¿™ä¸ªä»»åŠ¡ä»¥åè¿›å…¥å®šæ—¶å™¨é˜¶æ®µæ—¶å‘ç°æœ‰å®šæ—¶å™¨é˜ˆå€¼åˆ°äº†ï¼Œå¯ä»¥å¼€å§‹æ‰§è¡Œäº†ï¼Œç„¶åå¼€å§‹æ‰§è¡Œè¿™ä¸ªå®šæ—¶å™¨å›è°ƒã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå®é™…ç­‰å¾…æ—¶é—´æ¯”æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å¤šäº† `5ms`ã€‚

æ³¨æ„ï¼šä¸ºé˜²æ­¢**è½®è¯¢**é˜¶æ®µé•¿æ—¶é—´ç‹¬å å¾ªç¯ï¼Œä½¿å…¶ä»–é˜¶æ®µé•¿æ—¶é—´å¾—ä¸åˆ°æ‰§è¡Œï¼Œ[libuv](httpss://libuv.org/) ï¼ˆä¸€ä¸ªå®ç°äº† Node.js äº‹ä»¶å¾ªç¯å’Œå¹³å°çš„æ‰€æœ‰å¼‚æ­¥è¡Œä¸ºçš„ C åº“ï¼‰åœ¨åœæ­¢è½®è¯¢æ›´å¤šäº‹ä»¶ä¹‹å‰ï¼Œè¿˜å…·æœ‰ä¸€ä¸ªå›ºå®šçš„æœ€å¤§å€¼ï¼ˆå–å†³äºç³»ç»Ÿï¼‰ã€‚



### 2 I/O å›è°ƒç­‰å¾… Pending callbacks

æ­¤é˜¶æ®µæ‰§è¡Œä¸Šè½®æ®‹ç•™çš„å›è°ƒï¼Œå’Œå¯¹æŸäº›ç³»ç»Ÿæ“ä½œï¼ˆå¦‚ TCP é”™è¯¯ç±»å‹ï¼‰æ‰§è¡Œå›è°ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœTCPå¥—æ¥å­—åœ¨å°è¯•è¿æ¥æ—¶æ¥æ”¶åˆ° `ECONNREFUSED`ï¼Œåˆ™æŸäº› `*nix` ç³»ç»Ÿå¸Œæœ›ç­‰å¾…æŠ¥å‘Šé”™è¯¯ã€‚è¿™å°†åœ¨æŒ‚èµ·çš„å›è°ƒé˜¶æ®µæ’é˜Ÿæ‰§è¡Œã€‚



### 3 ide & prepare

è¿™ä¸ªé˜¶æ®µä»…ä¾› Node.js å†…éƒ¨ä½¿ç”¨



### 4 è½®è¯¢ Poll

è¿™ä¸ªé˜¶æ®µæœ‰ä¸¤ä¸ªä¸»è¦çš„åŠŸèƒ½ï¼š

1. ä¸ºé˜ˆå€¼å·²ç»åˆ°äº†çš„å®šæ—¶å™¨æ‰§è¡Œä¸€äº›å›è°ƒ
2. å¤„ç†é˜Ÿåˆ—é‡Œçš„äº‹ä»¶

 å½“äº‹ä»¶å¾ªç¯è¿›å…¥è¿™ä¸ªé˜¶æ®µä¸”æ²¡æœ‰å®šæ—¶å™¨æ—¶ï¼Œåˆ™ï¼š

- å¦‚æœè½®è¯¢å›è°ƒé˜Ÿåˆ—é‡Œä¸ä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯å°†éå†å›è°ƒé˜Ÿåˆ—ï¼ŒåŒæ­¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ç›´åˆ°é˜Ÿåˆ—ç©ºäº†æˆ–è¾¾åˆ°ä¾èµ–äºç³»ç»Ÿçš„æœ€å¤§å€¼ã€‚
- å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ï¼š
  - å¦‚æœå­˜åœ¨ `setImmediate()` ï¼Œäº‹ä»¶å¾ªç¯å°†ç»“æŸæ­¤é˜¶æ®µè¿›å…¥ `check` é˜¶æ®µæ¥æ‰§è¡Œ `setImmediate()` çš„å›è°ƒã€‚
  - å¦‚æœä¸å­˜åœ¨ `setImmediate()` ï¼Œäº‹ä»¶å¾ªç¯å°†ç­‰å¾…è½®è¯¢é˜¶æ®µçš„å›è°ƒå…¥é˜Ÿï¼Œç„¶åç«‹åˆ»æ‰§è¡Œè¿™äº›å›è°ƒã€‚

ä¸€æ—¦è½®è¯¢é˜Ÿåˆ—ä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯å°†æ£€æŸ¥æ˜¯å¦æœ‰é˜ˆå€¼åˆ°è¾¾äº†çš„å®šæ—¶å™¨ï¼Œå¦‚æœæœ‰ï¼Œäº‹ä»¶å¾ªç¯å°†è¿”å›åˆ°å®šæ—¶å™¨é˜¶æ®µæ¥æ‰§è¡Œè¿™äº›å®šæ—¶å™¨çš„å›è°ƒã€‚



###  5 æ£€å®š Check

è¿™ä¸ªé˜¶æ®µå…è®¸æˆ‘ä»¬åœ¨è½®è¯¢é˜¶æ®µå®Œæˆåç«‹åˆ»æ‰§è¡Œä¸€äº›å›è°ƒã€‚å¦‚æœè½®è¯¢é˜¶æ®µå˜ä¸ºç©ºé—²ï¼Œå¹¶ä¸”æœ‰ `setImmediate()` çš„å›è°ƒæ’é˜Ÿï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯å¯èƒ½ä¼šç»§ç»­è¿›å…¥ check é˜¶æ®µï¼Œè€Œä¸æ˜¯ç­‰å¾…è½®è¯¢å›è°ƒå…¥é˜Ÿã€‚

`setImmediate()` å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å®šæ—¶å™¨ï¼Œå®ƒåœ¨äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå•ç‹¬çš„é˜¶æ®µä¸­è¿è¡Œã€‚åœ¨è½®è¯¢é˜¶æ®µå®Œæˆä¹‹åï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª `libuv` API è°ƒåº¦å›è°ƒæ‰§è¡Œã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œéšç€ä»£ç æ‰§è¡Œï¼Œäº‹ä»¶å¾ªç¯æœ€ç»ˆä¼šåˆ°è¾¾ `check` é˜¶æ®µï¼Œåœ¨è¯¥é˜¶æ®µç­‰å¾…ä¸€ä¸ªä¼ å…¥è¿æ¥ã€è¯·æ±‚ç­‰ã€‚



### 5 å…³é—­ç±»äº‹ä»¶å›è°ƒ Close callbacks

å¦‚æœä¸€ä¸ª socket æˆ– handle çªç„¶å…³é—­ï¼ˆå¦‚ï¼š`socket.destroy()` ï¼‰ï¼Œè¿™ä¸ªé˜¶æ®µå°†å‘é€ `close` äº‹ä»¶ã€‚å¦åˆ™è¿™ä¸ª `close` äº‹ä»¶å°†é€šè¿‡ `process.nextTick()` å‘é€ã€‚

> **`setImmediate()` VS `setTimeout()`**
>
> å®ƒä»¬ å¾ˆåƒï¼ŒåŒºåˆ«åœ¨äºæ‰§è¡Œçš„æ—¶é—´ç‚¹ï¼š
>
> - `setImmediate()` åœ¨å½“å‰è½®è¯¢é˜¶æ®µå®Œæˆåæ‰§è¡Œã€‚
> - `setTimeout()` åœ¨è¾¾åˆ°æ‰€å®šçš„æ—¶é—´ï¼ˆå•ä½ï¼šmsï¼‰ä»¥åè¢«æ‰§è¡Œã€‚
>
> å®ƒä»¬è¢«æ‰§è¡Œçš„é¡ºåºä¾èµ–äºå®ƒä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­çš„ä½ç½®ã€‚å¦‚æœè¿™ä¸¤ä¸ªéƒ½æ˜¯åœ¨ä¸»æ¨¡å—å†…éƒ¨è°ƒç”¨çš„ï¼Œé‚£ä¹ˆå®šæ—¶å™¨å°†å—åˆ°è¿›ç¨‹æ€§èƒ½çš„é™åˆ¶ï¼ˆå—è¿è¡Œåœ¨è¿™ä¸ªæœºå™¨ä¸Šçš„å…¶å®ƒåº”ç”¨ç¨‹åºå½±å“ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢é‚£ä¸ª `100ms` å°±ä¸æ˜¯å¾ˆå‡†...ï¼‰



## æ¢ä¸ªè§’åº¦çœ‹

### åˆ†ä»»åŠ¡é˜Ÿåˆ—

æ‰€æœ‰çš„ä»»åŠ¡å¯ä»¥åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ä¸€èˆ¬ä¼šç›´æ¥è¿›å…¥åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

è€Œå¼‚æ­¥ä»»åŠ¡ï¼Œå°±æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ AJAX ç½‘ç»œè¯·æ±‚ï¼Œ`setTimeout` å®šæ—¶å‡½æ•°ç­‰éƒ½å±äºå¼‚æ­¥ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡ä¼šé€šè¿‡ä»»åŠ¡é˜Ÿåˆ— ï¼ˆEvent Queue ï¼‰çš„æœºåˆ¶æ¥è¿›è¡Œåè°ƒã€‚

åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡åˆ†åˆ«è¿›å…¥ä¸åŒçš„æ‰§è¡Œç¯å¢ƒï¼ŒåŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå³ **ä¸»æ‰§è¡Œæ ˆ**ï¼Œå¼‚æ­¥çš„è¿›å…¥ Event Queue ã€‚ä¸»çº¿ç¨‹å†…çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¸ºç©ºï¼Œä¼šå» Event Queue è¯»å–å¯¹åº”çš„ä»»åŠ¡ï¼Œæ¨å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œä¸Šè¿°è¿™ä¸ªè¿‡ç¨‹çš„ä¸æ–­é‡å¤å…¶å®å°±æ˜¯æˆ‘ä»¬è¯´çš„ **äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰**

![](https://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-02-05-WeChatabdbee12ee5a7e71794be6fe21bf16b9.png)

è¿™é‡Œç›¸ä¿¡æœ‰äººä¼šæƒ³é—®ï¼Œä»€ä¹ˆæ˜¯ microtasks ï¼Ÿ

è§„èŒƒä¸­è§„å®šï¼Œtask åˆ†ä¸ºä¸¤å¤§ç±», åˆ†åˆ«æ˜¯ **Macro Taskï¼ˆå®ä»»åŠ¡ï¼‰** å’Œ **Micro Taskï¼ˆå¾®ä»»åŠ¡ï¼‰**, å¹¶ä¸”æ¯ä¸ªå®ä»»åŠ¡ç»“æŸå, éƒ½è¦æ¸…ç©ºæ‰€æœ‰çš„å¾®ä»»åŠ¡ã€‚

è¿™é‡Œçš„ Macro Task ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„ task ï¼Œæœ‰äº›æ–‡ç« å¹¶æ²¡æœ‰åšåŒºåˆ†ï¼Œåé¢æåŠçš„ task çš†è§†ä¸ºå®ä»»åŠ¡ï¼ˆmacro taskï¼‰



### åˆ†æç¤ºä¾‹ä»£ç 

åƒè¨€ä¸‡è¯­ï¼Œä¸å¦‚å°±ç€ä¾‹å­è®²æ¥çš„æ¸…æ¥šã€‚ä¸‹é¢æˆ‘ä»¬å¯ä»¥æŒ‰ç…§è§„èŒƒï¼Œä¸€æ­¥æ­¥æ‰§è¡Œè§£æï¼Œå…ˆè´´ä¸€ä¸‹ä¾‹å­ä»£ç ï¼š

```js
console.log('script start');

setTimeout(function() {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(function() {
  console.log('promise1');
}).then(function() {
  console.log('promise2');
});

console.log('script end');
```

1. **æ•´ä½“è¿™æ®µä»£ç ä½œä¸ºç¬¬ä¸€ä¸ªå®ä»»åŠ¡** è¿›å…¥ä¸»çº¿ç¨‹ï¼Œé‡åˆ° `console.log`ï¼Œè¾“å‡º `script start`
2. é‡åˆ° `setTimeout`ï¼Œå…¶å›è°ƒå‡½æ•°è¢«åˆ†å‘åˆ°å®ä»»åŠ¡ Event Queue ä¸­
3. é‡åˆ° `Promise`ï¼Œå…¶ `then` å‡½æ•°è¢«åˆ†åˆ°åˆ°å¾®ä»»åŠ¡ Event Queue ä¸­,è®°ä¸º then1ï¼Œä¹‹ååˆé‡åˆ°äº† `then` å‡½æ•°ï¼Œå°†å…¶åˆ†åˆ°å¾®ä»»åŠ¡ Event Queue ä¸­ï¼Œè®°ä¸º then2
4. é‡åˆ° `console.log`ï¼Œè¾“å‡º `script end`

è‡³æ­¤ï¼ŒEvent Queue ä¸­å­˜åœ¨ä¸‰ä¸ªä»»åŠ¡ï¼Œå¦‚ä¸‹è¡¨ï¼š

| å®ä»»åŠ¡ | å¾®ä»»åŠ¡ |
| ---------- | ------ |
| setTimeout | then1  |
| -          | then2  |

1. æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œé¦–å…ˆæ‰§è¡Œ then1ï¼Œè¾“å‡º `promise1`, ç„¶åæ‰§è¡Œ then2ï¼Œè¾“å‡º `promise2`ï¼Œè¿™æ ·å°±æ¸…ç©ºäº†æ‰€æœ‰å¾®ä»»åŠ¡

2. æ‰§è¡Œ setTimeout ä»»åŠ¡ï¼Œè¾“å‡º `setTimeout`ï¼Œè‡³æ­¤ï¼Œè¾“å‡ºçš„é¡ºåºæ˜¯ï¼š

   ```txt
   script start 
   script end 
   promise1
   promise2
   setTimeout
   ```

æ€ä¹ˆæ ·ï¼Ÿè¿™ç§åƒæ¢æ¡ˆä¸€æ ·çš„æ„Ÿè§‰è¿‡ç˜¾å§ï¼Ÿé‚£å†æ¥ä¸ªæœ‰ç‚¹éš¾åº¦çš„ï¼š

```js
console.log('script start');

setTimeout(function() {
  console.log('timeout1');
}, 10);

new Promise(resolve => {
    console.log('promise1');
    resolve();
    setTimeout(() => console.log('timeout2'), 10);
}).then(function() {
    console.log('then1')
})

console.log('script end');
```

å˜»å˜»ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œè´´æˆ‘åšå¥½çš„æµç¨‹å›¾å•¦ï¼Œ[ä½ ç‚¹å‡»æ­¤é“¾æ¥ç›´æ¥æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹ç­”æ¡ˆå§ï¼](https://rpzoss.oss-cn-chengdu.aliyuncs.com/tmyBlog/2020-02-05-WeChat879999a8bb40303296aeb5b0714bca2f.png)

> **ä¸€ä¸ª Trickyï¼š** æŒ‰ç…§è§„èŒƒï¼Œé¦–å…ˆæ˜¯æ•´ä¸ª Script ä»£ç çš„ä¸€æ¬¡ taskï¼Œé‚£ä¹ˆé™¤äº†æœ¬èº«çš„ä»£ç ï¼Œä¸€äº› microtask å› ä¸ºè¦åœ¨æ­¤è½® Tick ä¸­æ¸…é™¤ï¼Œæ•…è€Œä¼˜å…ˆäº Script ä»£ç ä¸­å®šä¹‰çš„ task æ‰§è¡Œï¼Œæ‰€ä»¥å¦‚æœæœ‰éœ€è¦ä¼˜å…ˆæ‰§è¡Œçš„é€»è¾‘ï¼Œæ”¾å…¥ microtask é˜Ÿåˆ—ä¼šæ¯” task æ›´æ—©çš„è¢«æ‰§è¡Œã€‚



## è¯­æ³•ç³–

### async

`async/await`å®é™…ä¸Šæ˜¯`Generator`çš„è¯­æ³•ç³–ã€‚é¡¾åæ€ä¹‰ï¼Œ`async`å…³é”®å­—ä»£è¡¨åé¢çš„å‡½æ•°ä¸­æœ‰å¼‚æ­¥æ“ä½œï¼Œ`await`è¡¨ç¤ºç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚å£°æ˜å¼‚æ­¥å‡½æ•°åªéœ€åœ¨æ™®é€šå‡½æ•°å‰é¢åŠ ä¸€ä¸ªå…³é”®å­—`async`å³å¯ï¼Œå¦‚ï¼š

```js
async function funcA() {}
```

`async` å‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼ˆå¦‚æœæŒ‡å®šçš„è¿”å›å€¼ä¸æ˜¯Promiseå¯¹è±¡ï¼Œ **ä¹Ÿè¿”å›ä¸€ä¸ªPromise**ï¼Œåªä¸è¿‡ç«‹å³ `resolve `ï¼Œå¤„ç†æ–¹å¼åŒ `then `æ–¹æ³•ï¼‰ï¼Œå› æ­¤ `async `å‡½æ•°é€šè¿‡ `return `è¿”å›çš„å€¼ï¼Œä¼šæˆä¸º `then `æ–¹æ³•ä¸­å›è°ƒå‡½æ•°çš„å‚æ•°ï¼š

```js
async function funcA() {
  return 'hello!';
}

funcA().then(value => {
  console.log(value);
})
// hello!
```

å•ç‹¬ä¸€ä¸ª `async `å‡½æ•°ï¼Œå…¶å®ä¸ Promise æ‰§è¡Œçš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚



### await

è€Œ `await  `é¡¾åæ€ä¹‰å°±æ˜¯ **å¼‚æ­¥ç­‰å¾…**ï¼Œå®ƒç­‰å¾…çš„æ˜¯ä¸€ä¸ª Promiseï¼Œå› æ­¤ `await `åé¢åº”è¯¥å†™ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯Promiseå¯¹è±¡ï¼Œé‚£ä¹ˆä¼šè¢«è½¬æˆä¸€ä¸ªç«‹å³ `resolve `çš„ Promiseã€‚ `async `å‡½æ•°è¢«è°ƒç”¨åå°±ç«‹å³æ‰§è¡Œï¼Œä½†æ˜¯ä¸€æ—¦é‡åˆ° `await `å°±ä¼šå…ˆè¿”å›ï¼Œç­‰åˆ°å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæˆï¼Œå†æ¥ç€æ‰§è¡Œå‡½æ•°ä½“å†…åé¢çš„è¯­å¥ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š`async`å‡½æ•°è°ƒç”¨ä¸ä¼šé€ æˆä»£ç çš„é˜»å¡ï¼Œä½†æ˜¯`await`ä¼šå¼•èµ·`async`å‡½æ•°å†…éƒ¨ä»£ç çš„é˜»å¡ã€‚çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```js
async function foo() {
  console.log('async function is running!');
  const num1 = await 200;
  console.log(`num1 is ${num1}`);
  const num2 = await num1+ 100;
  console.log(`num2 is ${num2}`);
  const num3 = await num2 + 100;
  console.log(`num3 is ${num3}`);
}

foo();
console.log('run me before await!');
// async function is running!
// run me before await!
// num1 is 200
// num2 is 300
// num3 is 400
```

å¯ä»¥çœ‹å‡ºè°ƒç”¨ `async foo`  å‡½æ•°åï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œï¼Œé¦–å…ˆè¾“å‡ºäº†`'async function is running!'`ï¼Œæ¥ç€é‡åˆ°äº† `await `å¼‚æ­¥ç­‰å¾…ï¼Œå‡½æ•°è¿”å›ã€‚å…ˆæ‰§è¡Œ`foo() `åé¢çš„åŒæ­¥ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œæ¥ç€ `await` ç­‰å¾…çš„ä½ç½®ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚

åˆ«å¿˜äº†æˆ‘ä»¬ä¸Šé¢å¯æ˜¯åšè¿‡ `Promise.resolve.then()` çš„åˆ†æçš„å“¦ï¼å½“é‡åˆ° `await`ï¼Œè¿™é‡Œæ˜¯ `200` è¿™æ ·çš„é Promise ä¼šè¢«è½¬ä¸ºç›´æ¥ `resolve` çš„ï¼Œé‚£ä¹ˆå°±æ˜¯æ¨è¿›äº†å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œæ ¹æ®æœºåˆ¶å…ˆé€€å‡º `foo` ï¼Œç„¶åå¤–å±‚æ•´ä¸ª Script çš„ task è¿˜æ²¡ç»“æŸï¼Œä¹‹å... å°±ä¸ç”¨ç»†ç»†åˆ†è¯´äº† ğŸ¤£

å¯ä»¥è¯´ï¼Œ`async` å‡½æ•°å®Œå…¨å¯ä»¥çœ‹ä½œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼ŒåŒ…è£…æˆçš„ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œ`await`å‘½ä»¤å°±æ˜¯å†…éƒ¨`then`å‘½ä»¤çš„è¯­æ³•ç³–ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ `await `åé¢çš„ Promise å¯¹è±¡ä¸æ€»æ˜¯è¿”å› `resolved `çŠ¶æ€ï¼Œåªè¦ä¸€ä¸ª `await `åé¢çš„PromiseçŠ¶æ€å˜ä¸º `rejected `ï¼Œæ•´ä¸ª `async `å‡½æ•°éƒ½ä¼šä¸­æ–­æ‰§è¡Œï¼Œä¸ºäº†ä¿å­˜é”™è¯¯çš„ä½ç½®å’Œé”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ `try...catch` è¯­å¥æ¥å°è£…å¤šä¸ª `await `è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼š

```js
async function func() {
  try {
    const num1 = await 200;
    console.log(`num1 is ${num1}`);
    const num2 = await Promise.reject('num2 is wrong!');
    console.log(`num2 is ${num2}`);
    const num3 = await num2 + 100;
    console.log(`num3 is ${num3}`);
  } catch (error) {
    console.log(error);
  }
}

func();
// num1 is 200
// å‡ºé”™äº†
// num2 is wrong!
```

è¿™ä¸ªè¯­æ³•ç³–æœ€å¥½çš„å°±æ˜¯ï¼š **å¯ä»¥ç”¨åŒæ­¥çš„æ–¹å¼ã€æ€è·¯ä¸æ ¼å¼å»å†™å¼‚æ­¥çš„ä»£ç ï¼**æ›´åŠ ç¬¦åˆç¼–ç¨‹ä¹ æƒ¯ã€‚



## å‚è€ƒèµ„æ–™

- [Node.js å®˜æ–¹æ–‡æ¡£ Guide è‹±æ–‡åŸç‰ˆ: The Node.js Event Loop, Timers, and `process.nextTick()`](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)

- [ã€è¯‘æ–‡ã€‘Node.jsçš„äº‹ä»¶å¾ªç¯ï¼ˆEvent loopï¼‰ã€å®šæ—¶å™¨ï¼ˆTimersï¼‰å’Œ process.nextTick()](https://www.jianshu.com/p/3c3bd24e7c12)

- [æ·±å…¥ç†è§£JavaScriptäº‹ä»¶å¾ªç¯æœºåˆ¶ - ä½œè€… ChessZhang](https://www.cnblogs.com/yugege/p/9598265.html)

- [ç†è§£ async/await - ä½œè€… Leon](https://segmentfault.com/a/1190000015488033)

